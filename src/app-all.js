/*
Copyright(c) 2011 Sylvain Filteau
*/
Ext.define("Refer.proxy.Page",{extend:"Ext.data.proxy.Memory",read:function(b,e,c){var d=this;var a=d.getReader();Ext.Ajax.request({url:"pages.json",success:function(g){var h=Ext.JSON.decode(g.responseText);var i=d._processNode(h);i.text=i.text||"Home";i.expanded=true;var f=a.read(i);Ext.apply(b,{resultSet:f});b.setCompleted();b.setSuccessful();Ext.callback(e,c||d,[b])}})},_processNode:function(c){var b=[];for(var a=0;a<c.child_nodes.length;a++){b.push(this._processNode(c.child_nodes[a]))}for(var a=0;a<c.pages.length;a++){var e=c.pages[a];b.push({id:e.id,text:e.title,leaf:true,})}var d={text:c.name,children:b};return d}});Ext.define("Refer.store.PageStore",{extend:"Ext.data.TreeStore",requires:["Refer.proxy.Page"],proxy:Ext.create("Refer.proxy.Page",{reader:{type:"json",root:"children"}})});Ext.define("Refer.view.PageTree",{extend:"Ext.tree.Panel",requires:["Refer.store.PageStore"],alias:"widget.pagetree",store:Ext.create("Refer.store.PageStore"),rootVisible:false});Ext.define("Refer.view.Page",{extend:"Ext.panel.Panel",alias:"widget.page",pagesPath:"pages",ui:"page",autoScroll:true,loadPage:function(b){var a=this;this.setLoading(true);Ext.Ajax.request({url:this.pagesPath+"/"+b,success:function(c){a.update(c.responseText);a.setLoading(false)}})}});Ext.define("Refer.controller.Pages",{extend:"Ext.app.Controller",views:["PageTree","Page"],refs:[{ref:"page",selector:"page"}],init:function(){this.control({pagetree:{itemclick:function(a,b){if(b.get("leaf")){var d=[b.get("id")];node=b.parentNode;while(node&&node.parentNode){if(node.get("text")!=""){d.unshift(node.get("text"))}node=node.parentNode}var c=d.join("/")+".html";this.getPage().loadPage(c)}}}})}});Ext.Loader.setConfig({enabled:true});Ext.application({name:"Refer",appFolder:"app",controllers:["Pages"],launch:function(){Ext.create("Ext.container.Viewport",{layout:"fit",items:[{layout:"border",items:[{region:"west",width:250,xtype:"pagetree"},{region:"center",xtype:"page"}]}]})}});
